<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="../css/style.css">
    <title>Results</title>
</head>

<body>
    <nav class="nav-wrapper">
        <a href="#" data-target="slide-out" class="sidenav-trigger"><i class="material-icons">menu</i></a>
        <a href="#" class="brand-logo"><img src="../img/letter f.jpg" class="circle" id="nav-logo"></a>
        <ul id="nav-mobile" class="right hide-on-med-and-down">
            <li><a href="../homePage.html">Search</a></li>
            <li><a href="saved.html">Saved</a></li>
            <li><a href="about.html">About</a></li>
        </ul>
    </nav>

    <ul id="slide-out" class="sidenav">
        <li>
            <div class="user-view">
                <div class="background blue lighten-4"></div>
                <a href="#logo"><img class="circle" id="nav-logo2" src="../img/letter f.jpg"></a>
            </div>
        </li>
        <li><a class="waves-effect modal-trigger" id="searchBtn" href="#modal1">Search</a></li>
        <li><a class="waves-effect" href="saved.html">Saved</a></li>
        <li><a class="waves-effect" href="about.html">About</a></li>
    </ul>
    <a class="waves-effect waves-light" href="#modal1"></a>

    <div id="modal1" class="modal">
        <div class="modal-content">
            <h4>Search Events!</h4>
            <div class="row">
                <form class="col s12">

                    <div class="input-field col s12">
                        <input placeholder="Enter City" id="city" type="text" class="validate">
                        <label for="city">City</label>
                        <a class="wave-effect wave-light btn" id="myLocation">Use My location</a>
                    </div>

                    <div class="input-field col s12">
                        <input placeholder="Event Keyword" id="keyword" type="text" class="validate">
                        <label for="keyword">Keyword</label>
                    </div>

                    <label for="radius">Distance (miles)</label>
                    <p class="range-field">
                        <input type="range" id="radius" min="0" max="200" />
                    </p>

                    <div class="input-field col s12">
                        <input id="startDate" type="text" class="datepicker">
                        <label for="startDate">Start Date <span class="material-icons">event</span></label>
                    </div>

                    <div class="input-field col s12">
                        <input id="endDate" type="text" class="datepicker">
                        <label for="endDate">End Date<span class="material-icons">event</span></label>
                    </div>

                    <div class="input-field col s12">
                        <select id="category">
                            <option value=" " disabled selected>Category Select</option>
                            <option value="Sports">Sports</option>
                            <option value="Music">Music</option>
                            <option value="Arts & Theatre">Arts & Theatre</option>
                            <option value="Film">Film</option>
                            <option value="Miscellaneous">Miscellaneous</option>
                        </select>
                        <label for="category">Event Category</label>
                    </div>


                    <div class="input-field col s12">
                        <select id="subCategory">
                            <option value=" " disabled selected>Sub-Category Select</option>
                        </select>
                        <label for="subCategory">Event Sub-Category</label>
                    </div>

                </form>
            </div>
        </div>
        <div class="modal-footer">
            <a id="submit" class="modal-close waves-effect waves-green btn-flat">Search</a>
        </div>
    </div>

    <div id="modal2" class="modal">
        <div class="modal-content">
            <h4>Invalid Search</h4>
            <p>Please enter a valid city name.</p>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-green btn-flat" id="modal2Close">Ok</a>
        </div>
    </div>

    <div class="row">
        <form class="col s4" id="search-form">
            <h1>Search</h1>
            <div class="input-field col s12">
                <input placeholder="Enter City" id="city2" type="text" class="validate">
                <label for="city">City</label>
                <a class="wave-effect wave-light btn" id="myLocation2">Use My location</a>
            </div>

            <div class="input-field col s12">
                <input placeholder="Event Keyword" id="keyword2" type="text" class="validate">
                <label for="keyword">Keyword</label>
            </div>

            <label for="radius">Distance (miles)</label>
            <p class="range-field">
                <input type="range" id="radius2" min="0" max="200" />
            </p>

            <div class="input-field col s12">
                <input id="startDate2" type="text" class="datepicker">
                <label for="startDate">Start Date <span class="material-icons">event</span></label>
            </div>

            <div class="input-field col s12">
                <input id="endDate2" type="text" class="datepicker">
                <label for="endDate">End Date<span class="material-icons">event</span></label>
            </div>

            <div class="input-field col s12">
                <select id="category2">
                    <option value=" " disabled selected>Category Select</option>
                    <option value="Sports">Sports</option>
                    <option value="Music">Music</option>
                    <option value="Arts & Theatre">Arts & Theatre</option>
                    <option value="Film">Film</option>
                    <option value="Miscellaneous">Miscellaneous</option>
                </select>
                <label for="category">Event Category</label>
            </div>

            <div class="input-field col s12">
                <select id="subCategory2">
                    <option value=" " disabled selected>Sub-Category Select</option>
                </select>
                <label for="subCategory">Event Sub-Category</label>
            </div>

            <a id="submit2" class="modal-close waves-effect waves-green btn-flat">Search</a>

        </form>

        <div class="col s12 l8">
            <h1>Results</h1>
            <h2 id="noResults"></h2>
            <div id="results">

            </div>
        </div>

        <div id="pageNav">
            <p id="nextPage"></p>
            <p id="prevPage"></p>
            <a class="waves-effect waves-light btn" id="prev">Prev</a>
            <a class="waves-effect waves-light btn" id="next">Next</a>
        </div>

    </div>

    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.js'
        integrity='sha256-H9jAz//QLkDOy/nzE9G4aYijQtkLt9FvGmdUTwBk6gs=' crossorigin='anonymous'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="../javascript/script.js"></script>
    <script src='../javascript/results.js'></script>
    <script src="../javascript/search.js"></script>
    <!-- javascript is included here because I can't fugure out how to use the import in another way. All other methods result in cors issue or function not found.-->
    <script type="module">
        import Geohash from 'https://cdn.jsdelivr.net/npm/latlon-geohash@2.0.0';
        //The search function triggers when the user hits the submit button.
        function search(event) {
            //We start by extracting the search parameters and assigning them variables. Most variable assignent accounts for a blank entry. Only the city name is required for the search to exticute.
            if ($(event.target).attr("id") == "submit") {
                if ($("#city").val() == "") {
                    $("#modal2").attr("class", "modal show");
                    return
                } else {
                    var city = $("#city").val();
                }

                if ($("#keyword").val().length == 0) {
                    var keyword = " ";
                } else {
                    var keyword = $("#keyword").val()
                }
                if ($("#radius").val() == "") {
                    var radius = 100;
                } else {
                    var radius = $("#radius").val()
                }
                var startDate = $("#startDate").val() + "T00:00:00Z";
                var endDate = $("#endDate").val() + "T23:59:00Z";
                var category = $("#category").val();
                var subCategory = $("#subCategory").val();
            } else {
                if ($("#city2").val() == "") {
                    $("#modal2").attr("class", "modal show");
                    return
                } else {
                    var city = $("#city2").val();
                }

                if ($("#keyword2").val().length == 0) {
                    var keyword = " ";
                } else {
                    var keyword = $("#keyword2").val()
                }
                if ($("#radius2").val() == "") {
                    var radius = 100;
                } else {
                    var radius = $("#radius2").val()
                }
                var startDate = $("#startDate2").val() + "T00:00:00Z";
                var endDate = $("#endDate2").val() + "T23:59:00Z";
                var category = $("#category2").val();
                var subCategory = $("#subCategory2").val();
            }


            console.log(category, subCategory);
            console.log(subCategory !== null, category !== null)
            if (subCategory !== null) {
                subCategory = eventType[category].genres[0][subCategory].id;
            } else {
                subCategory = " ";
            }
            if (category !== null) {
                category = eventType[category].id;
            } else {
                category = " ";
            }
            console.log(category, subCategory);
            //The cityCoords function is called an returnes the lat and lon of the city entered.
            cityCoords(city)
                .then(function (data) {
                    //The function will return if the openweathermap api is unable to find a city with the searched city name.
                    if (data == "break") {
                        return;
                    } else {
                        //using the imported library the lat and lon ar converted to a geohash.
                        var geohash = Geohash.encode(data[0], data[1], 6);
                        //qstring is created to carry over the search parameters to the results page. These will be used in the call to the ticketmaster api.
                        var qstring = "?city=" + city + "&keyword=" + keyword + "&radius=" + radius + "&start=" + startDate + "&end=" + endDate + "&category=" + category + "&sub=" + subCategory + "&geohash=" + geohash;
                        //the page location is switched to the results page.
                        document.location.replace("results.html" + qstring);
                    }

                })
        }
        //This event listener triggers the search function to happen when the button is clicked
        submit.on("click", search);
        submit2.on("click", search);
    </script>
</body>

</html>